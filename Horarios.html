<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Horarios</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/es.js"></script>
    <style>
        body {
            font-family: 'Noto Sans', sans-serif;
            background-color: #f3f4f6; /* Fondo gris claro de Tailwind */
        }
        /* Estilos personalizados para asegurar que el input de Flatpickr no sea visible */
        #date-picker-input-flatpickr {
            position: absolute;
            left: -9999px; /* Mueve el input fuera de la pantalla */
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div class="max-w-5xl mx-auto bg-white p-6 sm:p-8 rounded-2xl shadow-xl border border-gray-200">
        
        <div class="flex items-center gap-4 mb-6">
            <svg class="h-14 w-14 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5m-9-6h.008v.008H12v-.008zM12 15h.008v.008H12v-.008zM15 12h.008v.008H15v-.008zM15 15h.008v.008H15v-.008zM9 12h.008v.008H9v-.008zM9 15h.008v.008H9v-.008z" />
            </svg>
            <div>
                <h1 class="text-3xl sm:text-4xl font-bold text-indigo-600 mb-0">
                    Generador de Horarios 
                </h1>
                <p class="text-gray-600">
                    Define tus equipos, miembros y restricciones para generar un horario.
                </p>
            </div>
        </div>
        
        <a href="index.html" class="bg-indigo-600 text-white px-3 py-2 text-sm font-semibold rounded-lg hover:bg-indigo-700 transition duration-300 inline-block mb-4">Inicio</a>

        <div class="bg-white p-6 rounded-xl border border-gray-200 mb-8 shadow-md">
            <h2 class="text-2xl font-semibold text-gray-900 mb-4 text-center">Copia de Seguridad</h2>
            <div class="flex flex-col sm:flex-row justify-center gap-4">
                <button id="save-backup-btn" class="px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition duration-300 focus:outline-none focus:ring-2 focus:ring-indigo-400 shadow-sm">
                    Guardar Datos
                </button>
                <button id="load-backup-btn" class="px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition duration-300 focus:outline-none focus:ring-2 focus:ring-indigo-400 shadow-sm">
                    Cargar Datos
                </button>
                <button id="clear-data-btn" class="px-6 py-3 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition duration-300 focus:outline-none focus:ring-2 focus:ring-red-400 shadow-sm">
                    Limpiar Todos los Datos
                </button>
                <input type="file" id="backup-file-input" class="hidden" accept=".json">
            </div>
            <p class="text-sm text-gray-600 mt-4 text-center">
                Guarda o carga los equipos, miembros y restricciones en un archivo JSON.
            </p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <div class="flex flex-col gap-6">
                <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-md">
                    <h2 class="text-2xl font-semibold text-gray-900 mb-4">Paso 1: Define los días</h2>
                    
                    <div class="grid grid-cols-1 gap-4 mb-4 p-4 bg-gray-50 rounded-lg border">
                        <div class="flex items-center gap-4">
                            <button id="open-date-picker-btn" class="flex-shrink-0 px-4 py-2 bg-indigo-600 text-white text-sm font-semibold rounded-lg hover:bg-indigo-700 transition duration-200 focus:outline-none focus:ring-2 focus:ring-indigo-400">
                                <svg class="h-5 w-5 inline-block mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                  <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5m-9-6h.008v.008H12v-.008zM12 15h.008v.008H12v-.008zM15 12h.008v.008H15v-.008zM15 15h.008v.008H15v-.008zM9 12h.008v.008H9v-.008zM9 15h.008v.008H9v-.008z" />
                                </svg>
                                Seleccionar Fecha
                            </button>
                            <input type="date" id="date-picker-input-flatpickr" class="hidden">
                            <p id="selected-date-display" class="text-gray-700 text-sm flex-grow">Aún no se ha seleccionado ninguna fecha.</p>
                        </div>
                        <button id="add-selected-date-btn" class="mt-2 px-4 py-2 bg-indigo-600 text-white text-sm font-semibold rounded-lg hover:bg-indigo-700 transition duration-200">
                            Agregar al Listado de Días
                        </button>
                    </div>
                    
                    <p class="text-sm text-gray-600 mb-4 text-center">Días Seleccionados para el Horario:</p>
                    
                    <div id="days-container" class="space-y-4">
                        </div>
                </div>

                <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-md">
                    <h2 class="text-2xl font-semibold text-gray-900 mb-4">Paso 3: Restricción de Rotación</h2>
                    <p class="text-sm text-gray-600 mb-2">
                        Las personas en esta lista serán asignadas una sola vez por equipo al mes, si es posible. <br> (Ej: Juan, solo estará una vez en Equipo 1 y una vez en Equipo 2.)
                    </p>
                    <textarea id="rotation-list" rows="4" class="w-full p-3 rounded-lg border border-gray-300 bg-gray-50 text-gray-800 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition duration-200 resize-none" placeholder="Juan Pérez&#10;Mario López&#10;..."></textarea>
                </div>
            </div>

            <div class="flex flex-col gap-6">
                <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-md">
                    <h2 class="text-2xl font-semibold text-gray-900 mb-4">Paso 2: Define tus equipos</h2>
                    <div id="teams-container" class="space-y-6">
                        </div>
                    <button id="add-team-btn" class="mt-4 px-4 py-2 bg-indigo-600 text-white text-sm font-semibold rounded-lg hover:bg-indigo-700 transition duration-200">
                        Agregar Equipo
                    </button>
                </div>
                
                <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-md">
                    <h2 class="text-2xl font-semibold text-gray-900 mb-4">Paso 4: Define las restricciones de días</h2>
                    <div id="restrictions-container" class="space-y-4">
                        <p class="text-sm text-gray-600">Haz clic en "Agregar Restricción" para añadir días no disponibles por persona.</p>
                    </div>
                    <button id="add-restriction-btn" class="mt-4 px-4 py-2 bg-indigo-600 text-white text-sm font-semibold rounded-lg hover:bg-indigo-700 transition duration-200">
                        Agregar Restricción
                    </button>
                </div>
            </div>
        </div>
        
        <div class="bg-white p-6 rounded-xl border border-gray-200 mb-8 shadow-md">
            <h2 class="text-2xl font-semibold text-gray-900 mb-4">Paso 5: Generar y Exportar Horario</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div>
                    <label for="schedule-month" class="block text-sm font-medium text-gray-700">Mes del Horario (para la tabla):</label>
                    <input type="text" id="schedule-month" class="mt-1 block w-full p-2 rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="Ej: Diciembre 2025">
                </div>
                <div>
                    <label for="schedule-title" class="block text-sm font-medium text-gray-700">Título del Horario:</label>
                    <input type="text" id="schedule-title" class="mt-1 block w-full p-2 rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="Ej: Horario General">
                </div>
            </div>
            <div class="flex flex-col sm:flex-row justify-center gap-4">
                <button id="generate-btn" class="px-8 py-4 bg-indigo-600 text-white font-bold rounded-full shadow-lg hover:bg-indigo-700 transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-indigo-300">
                    Generar Horario
                </button>
                <button id="export-pdf-btn" class="px-8 py-4 bg-red-600 text-white font-bold rounded-full shadow-lg hover:bg-red-700 transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-red-300">
                    Exportar a PDF
                </button>
                <button id="export-excel-btn" class="px-8 py-4 bg-green-600 text-white font-bold rounded-full shadow-lg hover:bg-green-700 transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-green-300">
                    Exportar a Excel
                </button>
            </div>
        </div>

        <div id="schedule-container" class="mt-8">
            </div>

        <div id="alert-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
            <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                <div class="mt-3 text-center">
                    <h3 class="text-lg leading-6 font-medium text-gray-900" id="alert-title"></h3>
                    <div class="mt-2 px-7 py-3">
                        <p class="text-sm text-gray-500" id="alert-message"></p>
                    </div>
                    <div class="items-center px-4 py-3">
                        <button id="close-alert-btn" class="px-4 py-2 bg-indigo-600 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-400">
                            Cerrar
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="text-center text-gray-500 text-xs mt-8">
            <p><span class="font-bold">Nota:</span> <i>"Código corregido y mejorado con ayuda de I.A"</i></p>
            <p class="font-bold">-GOMLET-</p>
        </div>

    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // Referencias a elementos del DOM
            const daysContainer = document.getElementById('days-container');
            const teamsContainer = document.getElementById('teams-container');
            const addTeamBtn = document.getElementById('add-team-btn');
            const rotationListEl = document.getElementById('rotation-list');
            const restrictionsContainer = document.getElementById('restrictions-container');
            const addRestrictionBtn = document.getElementById('add-restriction-btn');
            const generateBtn = document.getElementById('generate-btn');
            const exportPdfBtn = document.getElementById('export-pdf-btn');
            const exportExcelBtn = document.getElementById('export-excel-btn');
            const scheduleContainer = document.getElementById('schedule-container');
            const scheduleTitleEl = document.getElementById('schedule-title');
            const scheduleMonthEl = document.getElementById('schedule-month');
            const saveBackupBtn = document.getElementById('save-backup-btn');
            const loadBackupBtn = document.getElementById('load-backup-btn');
            const backupFileInput = document.getElementById('backup-file-input');
            const clearDataBtn = document.getElementById('clear-data-btn');
            
            // NUEVAS REFERENCIAS DE CALENDARIO (Ahora con Flatpickr)
            const datePickerInput = document.getElementById('date-picker-input-flatpickr'); 
            const addSelectedDateBtn = document.getElementById('add-selected-date-btn'); 
            const openDatePickerBtn = document.getElementById('open-date-picker-btn'); 
            const selectedDateDisplay = document.getElementById('selected-date-display'); 
            
            const alertModal = document.getElementById('alert-modal');
            const alertTitle = document.getElementById('alert-title');
            const alertMessage = document.getElementById('alert-message');
            const closeAlertBtn = document.getElementById('close-alert-btn');

            let flatpickrInstance;
            
            // --- INICIALIZACIÓN DE FLATPCKR ---
            function initializeFlatpickr() {
                flatpickrInstance = flatpickr("#date-picker-input-flatpickr", {
                    locale: "es", // Usar idioma español
                    dateFormat: "Y-m-d", // Formato interno para JS
                    inline: false, // Asegurar que sea emergente
                    mode: "multiple", // HABILITA SELECCIÓN MÚLTIPLE
                    onChange: function(selectedDates, dateStr, instance) {
                        // Cuando se selecciona una fecha en el calendario
                        updateSelectedDateDisplay(selectedDates);
                    }
                });
            }
            initializeFlatpickr();

            /**
             * Muestra un modal de alerta personalizado.
             * @param {string} title - El título de la alerta.
             * @param {string} message - El mensaje de la alerta.
             */
            function showAlert(title, message) {
                alertTitle.textContent = title;
                alertMessage.textContent = message;
                alertModal.classList.remove('hidden');
            }

            // Cierra el modal de alerta
            closeAlertBtn.addEventListener('click', () => {
                alertModal.classList.add('hidden');
            });
            
            // Lógica de botones
            addTeamBtn.addEventListener('click', () => addTeamRow());
            addRestrictionBtn.addEventListener('click', () => addRestrictionRow());
            addSelectedDateBtn.addEventListener('click', addSelectedDate); 
            clearDataBtn.addEventListener('click', clearAllData);
            
            // LÓGICA DEL CALENDARIO FLATPCKR
            // Al hacer clic en el botón, se abre el calendario Flatpickr
            openDatePickerBtn.addEventListener('click', () => {
                 if (flatpickrInstance) {
                    flatpickrInstance.open();
                }
            });

            /**
             * Actualiza el texto con las fechas seleccionadas.
             * @param {Date[] | null} selectedDates - Array de objetos Date seleccionados.
             */
            function updateSelectedDateDisplay(selectedDates = null) {
                const dates = selectedDates && selectedDates.length > 0 ? selectedDates : (flatpickrInstance ? flatpickrInstance.selectedDates : []);
                
                if (dates.length > 0) {
                    const sortedDates = dates.sort((a, b) => a.getTime() - b.getTime());
                    const firstDate = sortedDates[0];
                    const lastDate = sortedDates[sortedDates.length - 1];

                    if (dates.length === 1) {
                        const dayName = firstDate.toLocaleString('es-ES', { weekday: 'long' });
                        const dayDate = firstDate.getDate();
                        const month = firstDate.toLocaleString('es-ES', { month: 'long' });
                        selectedDateDisplay.textContent = `Fecha seleccionada: ${dayName}, ${dayDate} de ${month}`;
                    } else {
                        // Muestra un resumen de las fechas seleccionadas
                        selectedDateDisplay.textContent = `${dates.length} días seleccionados (Del ${firstDate.getDate()} al ${lastDate.getDate()})`;
                    }
                } else {
                    selectedDateDisplay.textContent = 'Aún no se ha seleccionado ninguna fecha.';
                }
            }


            /**
             * Agrega una nueva fila de entrada de día a la UI.
             * @param {string} [day=''] - Nombre del día.
             * @param {number} [date=''] - Fecha del día.
             */
            function addDayRow(day = '', date = '') {
                const row = document.createElement('div');
                row.classList.add('flex', 'flex-col', 'sm:flex-row', 'gap-4', 'items-center', 'day-row', 'p-2', 'border', 'rounded-lg', 'bg-gray-50');
                row.innerHTML = `
                    <div class="w-full sm:w-1/2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Día de la semana:</label>
                        <input type="text" value="${day}" class="w-full p-2 border rounded-lg day-name-input bg-white text-gray-800 border-gray-300 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Ej. Miércoles">
                    </div>
                    <div class="w-full sm:w-1/2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Fecha del mes:</label>
                        <input type="number" value="${date}" class="w-full p-2 border rounded-lg day-date-input bg-white text-gray-800 border-gray-300 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Ej. 3">
                    </div>
                    <button class="text-gray-400 hover:text-red-500 transition duration-200 remove-btn mt-6 sm:mt-0" aria-label="Eliminar día">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </button>
                `;
                daysContainer.appendChild(row);

                row.querySelector('.remove-btn').addEventListener('click', () => {
                    daysContainer.removeChild(row);
                });
            }

            /**
             * Obtiene los días y sus fechas desde los campos de entrada de la UI.
             * @returns {Object[]} - Un array de objetos con el día de la semana y la fecha.
             */
            function getDaysFromInputs() {
                const days = [];
                const dayRows = daysContainer.querySelectorAll('.day-row');
                dayRows.forEach(row => {
                    const dayName = row.querySelector('.day-name-input').value.trim();
                    const dayDate = parseInt(row.querySelector('.day-date-input').value.trim());
                    if (dayName && !isNaN(dayDate)) {
                        days.push({ day: dayName, date: dayDate });
                    }
                });
                return days.sort((a, b) => a.date - b.date); // Ordenar por fecha
            }

            /**
             * Agrega la fecha(s) seleccionada(s) del calendario a la lista de días.
             */
            function addSelectedDate() {
                const selectedDates = flatpickrInstance ? flatpickrInstance.selectedDates : [];
                
                if (selectedDates.length === 0) {
                    showAlert('Error', 'Por favor, selecciona al menos un día del calendario antes de agregar.');
                    return;
                }

                let datesAdded = 0;
                const existingDays = getDaysFromInputs();
                const weekdayNames = ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'];

                try {
                    // Itera sobre todas las fechas seleccionadas
                    selectedDates.forEach(date => {
                        if (isNaN(date.getTime())) return;

                        const dayName = weekdayNames[date.getDay()];
                        const dayDate = date.getDate();

                        // Comprobar duplicados
                        const isDuplicate = existingDays.some(day => day.date === dayDate && day.day === dayName);

                        if (!isDuplicate) {
                            addDayRow(dayName, dayDate);
                            datesAdded++;
                        }
                    });

                    if (datesAdded > 0) {
                        // Limpiar la selección de Flatpickr y la visualización después de la adición
                        flatpickrInstance.clear();
                        updateSelectedDateDisplay();
                        showAlert('Éxito', `${datesAdded} día(s) agregado(s) correctamente al horario.`);
                    } else {
                        showAlert('Advertencia', 'Ningún día nuevo fue agregado. Es posible que ya estuvieran en la lista.');
                    }

                } catch (e) {
                    console.error('Error processing dates:', e);
                    showAlert('Error', 'Hubo un problema al procesar las fechas.');
                }
            }
            

            /**
             * Agrega una nueva fila de entrada de equipo a la UI.
             * @param {string} [name=''] - Nombre del equipo.
             * @param {string} [members=''] - Miembros del equipo.
             */
            function addTeamRow(name = '', members = '') {
                const row = document.createElement('div');
                row.classList.add('flex', 'flex-col', 'gap-4', 'p-4', 'border', 'rounded-lg', 'bg-gray-50', 'relative', 'shadow-sm', 'border-gray-200');
                row.innerHTML = `
                    <div class="flex-1">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nombre del Equipo:</label>
                        <input type="text" value="${name}" class="w-full p-2 border rounded-lg team-name-input bg-white text-gray-800 border-gray-300 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Ej. Audio">
                    </div>
                    <div class="flex-1">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Miembros (uno por línea):</label>
                        <textarea rows="6" class="w-full p-2 border rounded-lg team-members-input bg-white text-gray-800 border-gray-300 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Juan Pérez&#10;Mario López&#10;...">${members}</textarea>
                    </div>
                    <button class="absolute top-2 right-2 text-gray-400 hover:text-red-500 transition duration-200 remove-btn" aria-label="Eliminar equipo">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </button>
                `;
                teamsContainer.appendChild(row);

                row.querySelector('.remove-btn').addEventListener('click', () => {
                    teamsContainer.removeChild(row);
                });
            }

            /**
             * Obtiene los equipos y sus miembros desde los campos de entrada de la UI.
             * @returns {Object[]} - Un array de objetos con el nombre del equipo y sus miembros.
             */
            function getTeamsFromInputs() {
                const teams = [];
                const teamRows = teamsContainer.querySelectorAll('.flex.flex-col');
                teamRows.forEach(row => {
                    const nameInput = row.querySelector('.team-name-input');
                    const membersInput = row.querySelector('.team-members-input');
                    const teamName = nameInput.value.trim();
                    const members = membersInput.value.split('\n').map(name => name.trim()).filter(name => name);
                    if (teamName && members.length > 0) {
                        teams.push({ name: teamName, members: members });
                    }
                });
                return teams;
            }

            /**
             * Agrega una nueva fila de entrada de restricción a la UI.
             * @param {string} [name=''] - Nombre de la persona para la fila de ejemplo.
             * @param {string} [days=''] - Días de restricción para la fila de ejemplo.
             */
            function addRestrictionRow(name = '', days = '') {
                const row = document.createElement('div');
                row.classList.add('flex', 'flex-col', 'sm:flex-row', 'gap-4', 'items-center', 'restriction-row');
                row.innerHTML = `
                    <div class="w-full sm:w-1/2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nombre Completo:</label>
                        <input type="text" value="${name}" class="w-full p-2 border rounded-lg name-input bg-gray-50 text-gray-800 border-gray-300 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Antonio López">
                    </div>
                    <div class="w-full sm:w-1/2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Días que no puede (ej: 6, 13):</label>
                        <input type="text" value="${days}" class="w-full p-2 border rounded-lg days-input bg-gray-50 text-gray-800 border-gray-300 focus:ring-indigo-500 focus:border-indigo-500" placeholder="3, 10, 17">
                    </div>
                    <button class="text-gray-400 hover:text-red-500 transition duration-200 remove-btn mt-6 sm:mt-0" aria-label="Eliminar restricción">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </button>
                `;
                restrictionsContainer.appendChild(row);

                row.querySelector('.remove-btn').addEventListener('click', () => {
                    restrictionsContainer.removeChild(row);
                });
            }

            /**
             * Obtiene las restricciones de los campos de entrada de la UI.
             * @returns {Object.<string, number[]>} - Un objeto con los nombres y los días restringidos.
             */
            function getRestrictionsFromInputs() {
                const restrictions = {};
                const restrictionRows = restrictionsContainer.querySelectorAll('.restriction-row');
                restrictionRows.forEach(row => {
                    const nameInput = row.querySelector('.name-input');
                    const daysInput = row.querySelector('.days-input');
                    const name = nameInput.value.trim();
                    const daysStr = daysInput.value;
                    if (name && daysStr) {
                        const days = daysStr.split(',').map(d => parseInt(d.trim())).filter(d => !isNaN(d));
                        restrictions[name] = days;
                    }
                });
                return restrictions;
            }

            // --- LÓGICA DEL BOTÓN GENERAR HORARIO (CORREGIDA) ---
            generateBtn.addEventListener('click', () => {
                scheduleContainer.innerHTML = ''; // Limpiar horario anterior
                
                // Obtener los datos del usuario
                const teams = getTeamsFromInputs();
                const allTeamMembers = teams.flatMap(team => team.members);
                const uniqueMembers = [...new Set(allTeamMembers)];
                const restrictions = getRestrictionsFromInputs();
                const rotationMembers = rotationListEl.value.split('\n').map(name => name.trim()).filter(name => name);
                const specificDays = getDaysFromInputs();
                const scheduleTitle = scheduleTitleEl.value || 'Horario Generado';
                const scheduleMonth = scheduleMonthEl.value.trim(); 
                
                // --- VALIDACIÓN DE DATOS ---
                if (specificDays.length === 0) {
                    showAlert('Error', 'Debes definir al menos un día en el Paso 1. Usa el botón "Seleccionar Fecha" y luego "Agregar al Listado de Días".');
                    return;
                }
                if (teams.length === 0 || teams.every(t => t.members.length === 0)) {
                    showAlert('Error', 'Debes definir al menos un equipo con miembros en el Paso 2.');
                    return;
                }
                // --- FIN VALIDACIÓN ---

                try { 
                    // Generar el horario
                    const fullSchedule = generateCombinedSchedule(specificDays, teams, uniqueMembers, restrictions, rotationMembers);
                    
                    // Mostrar el horario en la página
                    renderSingleSchedule(fullSchedule, teams, scheduleTitle, scheduleMonth, restrictions);
                } catch (error) { 
                    console.error("Error al generar o renderizar el horario:", error);
                    showAlert('Error Fatal', 'Ocurrió un error inesperado al generar el horario. Revisa si tus datos de equipos, miembros y restricciones están completos y son válidos.');
                }
            });


            /**
             * Genera un horario combinado.
             * REFACTORIZADO: Devuelve un array de objetos para mejor manejo de datos.
             * MEJORADO: Intenta evitar asignaciones consecutivas al mismo equipo.
             */
            function generateCombinedSchedule(days, teams, allMembers, restrictions, rotationMembers) {
                const fullSchedule = [];
                const assignmentCounts = {}; // Registro de cuántas veces se ha asignado a cada miembro
                allMembers.forEach(member => {
                    assignmentCounts[member] = 0;
                });
                
                let previousDayAssignments = {}; // Para evitar asignaciones consecutivas

                days.forEach(dayInfo => {
                    const availableMembers = allMembers.filter(member => {
                        return !(restrictions[member] && restrictions[member].includes(dayInfo.date));
                    });
                    
                    const dayAssignments = {};
                    const assignedForToday = [];
    
                    const shuffledTeams = [...teams];
                    randomShuffle(shuffledTeams);
    
                    shuffledTeams.forEach(team => {
                        dayAssignments[team.name] = 'Sin asignar';
                        
                        const previousAssignee = previousDayAssignments[team.name]; // Quien estuvo ayer en este equipo
    
                        const teamCandidates = team.members.filter(member =>
                            availableMembers.includes(member) &&
                            !assignedForToday.includes(member)
                        );
    
                        // Ordenar por conteo de asignaciones
                        const sortedCandidates = teamCandidates.sort((a, b) => {
                            const isArotation = rotationMembers.includes(a);
                            const isBrotation = rotationMembers.includes(b);
                            if (isArotation === isBrotation) {
                                return assignmentCounts[a] - assignmentCounts[b];
                            }
                            return isArotation ? 1 : -1;
                        });

                        // Intentar filtrar al que estuvo ayer
                        const finalCandidates = sortedCandidates.filter(member => member !== previousAssignee);
                        
                        let selectedMember;
                        if (finalCandidates.length > 0) {
                            selectedMember = finalCandidates[0]; // Elegir al primero que no estuvo ayer
                        } else if (sortedCandidates.length > 0) {
                            selectedMember = sortedCandidates[0]; // Fallback: elegir al que tiene menos turnos, aunque repita
                        }

                        if (selectedMember) {
                            dayAssignments[team.name] = selectedMember;
                            assignedForToday.push(selectedMember);
                            assignmentCounts[selectedMember]++;
                        }
                    });
    
                    fullSchedule.push({
                        day: dayInfo.day,
                        date: dayInfo.date,
                        assignments: dayAssignments
                    });

                    previousDayAssignments = { ...dayAssignments }; // Guardar para la próxima iteración
                });
    
                return fullSchedule;
            }
            
            /**
             * Renderiza un único horario en la página como una tabla.
             * REFACTORIZADO: Acepta el array de horario y el mes.
             * MEJORADO: Resalta los conflictos.
             */
            function renderSingleSchedule(schedule, teams, scheduleTitle, scheduleMonth, restrictions) {
                if (schedule.length === 0) return;
                
                const teamNames = teams.map(t => t.name);

                let html = `
                    <div class="mb-8 p-4 bg-white rounded-xl border border-gray-200 shadow-md">
                        <h2 class="text-2xl font-bold text-gray-800 text-center mb-4">${scheduleTitle}</h2>
                        <div class="overflow-x-auto">
                            <table class="min-w-full text-left table-auto border-collapse">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="p-3 text-sm font-semibold tracking-wide text-gray-800">FECHAS</th>
                                        ${teamNames.map(name => `<th class="p-3 text-sm font-semibold tracking-wide text-gray-800">${name.toUpperCase()}</th>`).join('')}
                                    </tr>
                                </thead>
                                <tbody>
                                    ${schedule.map((dayData, index) => {
                                        // BUG FIX: Construir la fecha usando el mes (si existe)
                                        const dayDisplay = scheduleMonth 
                                            ? `${dayData.day} ${dayData.date} de ${scheduleMonth}`
                                            : `${dayData.day} ${dayData.date}`;

                                        return `
                                        <tr class="${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'} border-b border-gray-200">
                                            <td class="p-3 text-sm text-gray-700 font-bold">${dayDisplay}</td>
                                            ${teamNames.map(name => {
                                                const personName = dayData.assignments[name];
                                                const dayDate = dayData.date;
                                                
                                                // NUEVA FUNCIÓN: Resaltar conflictos
                                                let cellClass = 'p-3 text-sm text-gray-700';
                                                if (restrictions[personName] && restrictions[personName].includes(dayDate)) {
                                                    cellClass += ' bg-red-200 text-red-900 font-bold';
                                                }

                                                return `<td class="${cellClass}">${personName}</td>`;
                                            }).join('')}
                                        </tr>
                                    `}).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                scheduleContainer.innerHTML = html;
            }
            
            /**
             * Mezcla un array (Fisher-Yates shuffle).
             */
            function randomShuffle(array) {
                let currentIndex = array.length, randomIndex;
                while (currentIndex !== 0) {
                    randomIndex = Math.floor(Math.random() * currentIndex);
                    currentIndex--;
                    [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
                }
                return array;
            }

            // --- COPIA DE SEGURIDAD ---
            
            function downloadBackup() {
                const backupData = {
                    teams: getTeamsFromInputs(),
                    restrictions: getRestrictionsFromInputs(),
                    rotationList: rotationListEl.value,
                    days: getDaysFromInputs()
                };
                
                const dataStr = JSON.stringify(backupData, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = 'horario-backup.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showAlert('Copia de Seguridad', 'Datos guardados en "horario-backup.json".');
            }

            function loadBackupFromFile(file) {
                if (!file) {
                    showAlert('Error', 'No se seleccionó ningún archivo.');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const backupData = JSON.parse(event.target.result);
                        if (backupData && backupData.teams && backupData.restrictions) {
                            // Limpiar y cargar
                            teamsContainer.innerHTML = '';
                            backupData.teams.forEach(team => addTeamRow(team.name, team.members.join('\n')));

                            restrictionsContainer.innerHTML = '<p class="text-sm text-gray-600">Haz clic en "Agregar Restricción" para añadir días no disponibles por persona.</p>';
                            Object.keys(backupData.restrictions).forEach(member => {
                                addRestrictionRow(member, backupData.restrictions[member].join(', '));
                            });

                            rotationListEl.value = backupData.rotationList || '';
                            
                            daysContainer.innerHTML = '';
                            if (backupData.days && backupData.days.length > 0) {
                                backupData.days.forEach(day => addDayRow(day.day, day.date));
                            } 

                            showAlert('Copia de Seguridad', '¡Datos cargados exitosamente!');
                        } else {
                            showAlert('Error', 'El archivo no tiene un formato de respaldo válido.');
                        }
                    } catch (e) {
                        console.error('Error al procesar el archivo:', e);
                        showAlert('Error', 'Hubo un problema al leer el archivo.');
                    }
                };
                reader.onerror = () => showAlert('Error', 'No se pudo leer el archivo.');
                reader.readAsText(file);
            }

            /**
             * NUEVA FUNCIÓN: Limpia todos los datos del formulario.
             */
            function clearAllData() {
                if (confirm('¿Estás seguro de que quieres borrar todos los datos? Esta acción no se puede deshacer.')) {
                    daysContainer.innerHTML = '';
                    teamsContainer.innerHTML = '';
                    restrictionsContainer.innerHTML = '<p class="text-sm text-gray-600">Haz clic en "Agregar Restricción" para añadir días no disponibles por persona.</p>';
                    rotationListEl.value = '';
                    scheduleContainer.innerHTML = '';
                    scheduleTitleEl.value = '';
                    scheduleMonthEl.value = '';
                    
                    addTeamRow();

                    showAlert('Éxito', 'Todos los datos han sido borrados.');
                }
            }

            // Asignar eventos a los botones de copia de seguridad
            saveBackupBtn.addEventListener('click', downloadBackup);
            
            loadBackupBtn.addEventListener('click', () => {
                backupFileInput.click();
            });

            backupFileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                loadBackupFromFile(file);
                event.target.value = null; // Resetear el input
            });

            // Llenar con datos de ejemplo vacíos (solo equipos)
            if (teamsContainer.children.length === 0) {
                addTeamRow();
            }
            
            // Inicializar el display de la fecha
            updateSelectedDateDisplay();
        });
    </script>
</body>
</html>
