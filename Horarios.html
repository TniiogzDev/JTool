<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Horarios</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .glass-morphism {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }
        .input-field {
            transition: all 0.3s ease;
        }
        .input-field:focus {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(75, 109, 166, 0.15);
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }
    </style>
</head>
<body class="min-h-screen py-8 px-4">

    <div class="max-w-6xl mx-auto">
        <!-- Header con logo -->
        <div class="text-center mb-8 fade-in">
            <div class="inline-flex items-center justify-center w-20 h-20 bg-white rounded-full shadow-lg mb-4">
                <svg class="w-12 h-12 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                </svg>
            </div>
            <h1 class="text-5xl font-bold text-white mb-3 drop-shadow-lg">
                Generador de Horarios
            </h1>
            <p class="text-xl text-white/90 mb-6">
                Organiza equipos y gestiona turnos de manera inteligente
            </p>
            <a href="index.html" class="inline-flex items-center gap-2 bg-white/20 hover:bg-white/30 text-white px-6 py-3 rounded-full backdrop-blur-sm transition-all duration-300 hover:scale-105">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                </svg>
                Volver al inicio
            </a>
        </div>

        <div class="glass-morphism rounded-3xl shadow-2xl p-8 space-y-8 fade-in">
            
            <!-- Secci√≥n de Backup -->
            <div class="bg-gradient-to-r from-indigo-50 to-purple-50 p-6 rounded-2xl border border-indigo-100">
                <h2 class="text-2xl font-bold text-gray-800 mb-2 flex items-center gap-3">
                    <svg class="w-7 h-7 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"/>
                    </svg>
                    Copia de Seguridad
                </h2>
                <p class="text-sm text-gray-600 mb-4">Guarda y carga tus configuraciones</p>
                <div class="flex flex-wrap gap-3">
                    <button id="save-backup-btn" class="flex items-center gap-2 px-6 py-3 bg-indigo-600 text-white font-semibold rounded-xl hover:bg-indigo-700 transition-all duration-300 shadow-md hover:shadow-lg hover:scale-105">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"/>
                        </svg>
                        Guardar Datos
                    </button>
                    <button id="load-backup-btn" class="flex items-center gap-2 px-6 py-3 bg-purple-600 text-white font-semibold rounded-xl hover:bg-purple-700 transition-all duration-300 shadow-md hover:shadow-lg hover:scale-105">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
                        </svg>
                        Cargar Datos
                    </button>
                    <input type="file" id="backup-file-input" class="hidden" accept=".json">
                </div>
            </div>

            <!-- Paso 1: Mes y A√±o -->
            <div class="bg-white p-6 rounded-2xl border-2 border-indigo-100 shadow-sm hover:shadow-md transition-shadow duration-300">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center gap-3">
                    <span class="flex items-center justify-center w-8 h-8 bg-indigo-600 text-white rounded-full text-sm font-bold">1</span>
                    Define el Mes y A√±o
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Mes:</label>
                        <select id="month-select" class="w-full p-3 border-2 border-gray-200 rounded-xl input-field focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none">
                            <option value="Enero">Enero</option>
                            <option value="Febrero">Febrero</option>
                            <option value="Marzo">Marzo</option>
                            <option value="Abril">Abril</option>
                            <option value="Mayo">Mayo</option>
                            <option value="Junio">Junio</option>
                            <option value="Julio">Julio</option>
                            <option value="Agosto">Agosto</option>
                            <option value="Septiembre">Septiembre</option>
                            <option value="Octubre">Octubre</option>
                            <option value="Noviembre">Noviembre</option>
                            <option value="Diciembre">Diciembre</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">A√±o:</label>
                        <input type="number" id="year-input" value="2025" min="2020" max="2100" class="w-full p-3 border-2 border-gray-200 rounded-xl input-field focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none">
                    </div>
                </div>
            </div>

            <!-- Paso 2: D√≠as del mes -->
            <div class="bg-white p-6 rounded-2xl border-2 border-indigo-100 shadow-sm hover:shadow-md transition-shadow duration-300">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center gap-3">
                    <span class="flex items-center justify-center w-8 h-8 bg-indigo-600 text-white rounded-full text-sm font-bold">2</span>
                    Define los d√≠as del mes a programar
                </h2>
                <div id="days-container" class="space-y-3 mb-4"></div>
                <button id="add-day-btn" class="flex items-center gap-2 px-5 py-2.5 bg-indigo-600 text-white font-semibold rounded-xl hover:bg-indigo-700 transition-all duration-300 shadow-sm hover:shadow-md">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                    </svg>
                    Agregar D√≠a
                </button>
            </div>

            <!-- Paso 3: Equipos -->
            <div class="bg-white p-6 rounded-2xl border-2 border-indigo-100 shadow-sm hover:shadow-md transition-shadow duration-300">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center gap-3">
                    <span class="flex items-center justify-center w-8 h-8 bg-indigo-600 text-white rounded-full text-sm font-bold">3</span>
                    Define tus equipos
                </h2>
                <div id="teams-container" class="space-y-4 mb-4"></div>
                <button id="add-team-btn" class="flex items-center gap-2 px-5 py-2.5 bg-indigo-600 text-white font-semibold rounded-xl hover:bg-indigo-700 transition-all duration-300 shadow-sm hover:shadow-md">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                    </svg>
                    Agregar Equipo
                </button>
            </div>

            <!-- Paso 4: Restricci√≥n de Rotaci√≥n -->
            <div class="bg-white p-6 rounded-2xl border-2 border-indigo-100 shadow-sm hover:shadow-md transition-shadow duration-300">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center gap-3">
                    <span class="flex items-center justify-center w-8 h-8 bg-indigo-600 text-white rounded-full text-sm font-bold">4</span>
                    Restricci√≥n de Rotaci√≥n
                </h2>
                <p class="text-sm text-gray-600 mb-3 bg-amber-50 p-3 rounded-lg border border-amber-200">
                    üí° Las personas en esta lista ser√°n asignadas una sola vez por equipo al mes, si es posible.
                </p>
                <textarea id="rotation-list" rows="4" class="w-full p-3 border-2 border-gray-200 rounded-xl input-field focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none resize-none" placeholder="Juan P√©rez&#10;Mario L√≥pez&#10;..."></textarea>
            </div>
            
            <!-- Paso 5: Restricciones de d√≠as -->
            <div class="bg-white p-6 rounded-2xl border-2 border-indigo-100 shadow-sm hover:shadow-md transition-shadow duration-300">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center gap-3">
                    <span class="flex items-center justify-center w-8 h-8 bg-indigo-600 text-white rounded-full text-sm font-bold">5</span>
                    Define las restricciones de d√≠as
                </h2>
                <div id="restrictions-container" class="space-y-3 mb-4">
                    <p class="text-sm text-gray-600 bg-blue-50 p-3 rounded-lg border border-blue-200">üìÖ Agrega los d√≠as en que cada persona no est√° disponible</p>
                </div>
                <button id="add-restriction-btn" class="flex items-center gap-2 px-5 py-2.5 bg-indigo-600 text-white font-semibold rounded-xl hover:bg-indigo-700 transition-all duration-300 shadow-sm hover:shadow-md">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                    </svg>
                    Agregar Restricci√≥n
                </button>
            </div>

            <!-- Paso 6: Generar y Exportar -->
            <div class="bg-gradient-to-r from-green-50 to-emerald-50 p-6 rounded-2xl border-2 border-green-200 shadow-sm">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center gap-3">
                    <span class="flex items-center justify-center w-8 h-8 bg-green-600 text-white rounded-full text-sm font-bold">6</span>
                    Generar y Exportar Horario
                </h2>
                <div class="mb-4">
                    <label for="schedule-title" class="block text-sm font-semibold text-gray-700 mb-2">T√≠tulo del Horario:</label>
                    <input type="text" id="schedule-title" class="w-full p-3 border-2 border-gray-200 rounded-xl input-field focus:border-green-500 focus:ring-2 focus:ring-green-200 outline-none" placeholder="Ej: Horario de Diciembre 2025">
                </div>
                <div class="flex flex-wrap gap-3">
                    <button id="generate-btn" class="flex items-center gap-2 px-8 py-4 bg-gradient-to-r from-green-600 to-emerald-600 text-white font-bold rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 hover:scale-105">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                        </svg>
                        Generar Horario
                    </button>
                    <button id="export-pdf-btn" class="flex items-center gap-2 px-6 py-4 bg-red-600 text-white font-bold rounded-xl shadow-lg hover:shadow-xl hover:bg-red-700 transition-all duration-300 hover:scale-105">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                        </svg>
                        Exportar PDF
                    </button>
                    <button id="export-excel-btn" class="flex items-center gap-2 px-6 py-4 bg-emerald-600 text-white font-bold rounded-xl shadow-lg hover:shadow-xl hover:bg-emerald-700 transition-all duration-300 hover:scale-105">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        Exportar Excel
                    </button>
                </div>
            </div>

            <!-- Contenedor del horario -->
            <div id="schedule-container" class="fade-in"></div>

        </div>

        <!-- Footer -->
        <div class="text-center mt-8 text-white/80">
            <p class="text-sm"><b>Nota:</b> <i>"C√≥digo mejorado con ayuda de I.A"</i></p>
            <p class="font-bold mt-1">-GOMLET-</p>
        </div>
    </div>

    <!-- Modal de Alerta -->
    <div id="alert-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm overflow-y-auto h-full w-full z-50 flex items-center justify-center p-4">
        <div class="relative bg-white rounded-2xl shadow-2xl max-w-md w-full p-6 transform transition-all">
            <div class="text-center">
                <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-indigo-100 mb-4">
                    <svg class="h-8 w-8 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                </div>
                <h3 class="text-xl font-bold text-gray-900 mb-2" id="alert-title"></h3>
                <p class="text-sm text-gray-600 mb-6" id="alert-message"></p>
                <button id="close-alert-btn" class="w-full px-6 py-3 bg-indigo-600 text-white font-semibold rounded-xl hover:bg-indigo-700 transition-all duration-300 shadow-md hover:shadow-lg">
                    Cerrar
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const daysContainer = document.getElementById('days-container');
            const addDayBtn = document.getElementById('add-day-btn');
            const teamsContainer = document.getElementById('teams-container');
            const addTeamBtn = document.getElementById('add-team-btn');
            const rotationListEl = document.getElementById('rotation-list');
            const restrictionsContainer = document.getElementById('restrictions-container');
            const addRestrictionBtn = document.getElementById('add-restriction-btn');
            const generateBtn = document.getElementById('generate-btn');
            const exportPdfBtn = document.getElementById('export-pdf-btn');
            const exportExcelBtn = document.getElementById('export-excel-btn');
            const scheduleContainer = document.getElementById('schedule-container');
            const scheduleTitleEl = document.getElementById('schedule-title');
            const monthSelect = document.getElementById('month-select');
            const yearInput = document.getElementById('year-input');
            const saveBackupBtn = document.getElementById('save-backup-btn');
            const loadBackupBtn = document.getElementById('load-backup-btn');
            const backupFileInput = document.getElementById('backup-file-input');
            const alertModal = document.getElementById('alert-modal');
            const alertTitle = document.getElementById('alert-title');
            const alertMessage = document.getElementById('alert-message');
            const closeAlertBtn = document.getElementById('close-alert-btn');

            function showAlert(title, message) {
                alertTitle.textContent = title;
                alertMessage.textContent = message;
                alertModal.classList.remove('hidden');
            }

            closeAlertBtn.addEventListener('click', () => {
                alertModal.classList.add('hidden');
            });

            // Establecer mes actual
            const currentMonth = new Date().getMonth();
            monthSelect.selectedIndex = currentMonth;

            addDayBtn.addEventListener('click', () => addDayRow());
            addTeamBtn.addEventListener('click', () => addTeamRow());
            addRestrictionBtn.addEventListener('click', () => addRestrictionRow());

            function addDayRow(day = '', date = '') {
                const row = document.createElement('div');
                row.classList.add('flex', 'flex-col', 'sm:flex-row', 'gap-3', 'items-end', 'day-row', 'bg-gray-50', 'p-4', 'rounded-xl', 'border', 'border-gray-200');
                row.innerHTML = `
                    <div class="flex-1">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">D√≠a de la semana:</label>
                        <input type="text" value="${day}" class="w-full p-3 border-2 border-gray-200 rounded-xl day-name-input input-field focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none" placeholder="Ej. Mi√©rcoles">
                    </div>
                    <div class="flex-1">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Fecha del mes:</label>
                        <input type="number" value="${date}" class="w-full p-3 border-2 border-gray-200 rounded-xl day-date-input input-field focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none" placeholder="Ej. 3" min="1" max="31">
                    </div>
                    <button class="p-3 text-red-500 hover:bg-red-50 rounded-xl transition-all duration-200 remove-btn" aria-label="Eliminar d√≠a">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </button>
                `;
                daysContainer.appendChild(row);
                row.querySelector('.remove-btn').addEventListener('click', () => {
                    daysContainer.removeChild(row);
                });
            }

            function getDaysFromInputs() {
                const days = [];
                const dayRows = daysContainer.querySelectorAll('.day-row');
                dayRows.forEach(row => {
                    const dayName = row.querySelector('.day-name-input').value.trim();
                    const dayDate = parseInt(row.querySelector('.day-date-input').value.trim());
                    if (dayName && !isNaN(dayDate)) {
                        days.push({ day: dayName, date: dayDate });
                    }
                });
                return days;
            }

            function addTeamRow(name = '', members = '') {
                const row = document.createElement('div');
                row.classList.add('bg-gradient-to-br', 'from-gray-50', 'to-gray-100', 'p-5', 'rounded-xl', 'border-2', 'border-gray-200', 'relative', 'shadow-sm', 'hover:shadow-md', 'transition-shadow', 'duration-300');
                row.innerHTML = `
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Nombre del Equipo:</label>
                            <input type="text" value="${name}" class="w-full p-3 border-2 border-gray-200 rounded-xl team-name-input input-field focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none" placeholder="Ej. Audio">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Miembros (uno por l√≠nea):</label>
                            <textarea rows="5" class="w-full p-3 border-2 border-gray-200 rounded-xl team-members-input input-field focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none resize-none" placeholder="Juan P√©rez&#10;Mario L√≥pez&#10;...">${members}</textarea>
                        </div>
                    </div>
                    <button class="absolute top-3 right-3 p-2 text-red-500 hover:bg-red-50 rounded-lg transition-all duration-200 remove-btn" aria-label="Eliminar equipo">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </button>
                `;
                teamsContainer.appendChild(row);
                row.querySelector('.remove-btn').addEventListener('click', () => {
                    teamsContainer.removeChild(row);
                });
            }

            function getTeamsFromInputs() {
                const teams = [];
                const teamRows = teamsContainer.querySelectorAll('.bg-gradient-to-br');
                teamRows.forEach(row => {
                    const nameInput = row.querySelector('.team-name-input');
                    const membersInput = row.querySelector('.team-members-input');
                    const teamName = nameInput.value.trim();
                    const members = membersInput.value.split('\n').map(name => name.trim()).filter(name => name);
                    if (teamName && members.length > 0) {
                        teams.push({ name: teamName, members: members });
                    }
                });
                return teams;
            }

            function addRestrictionRow(name = '', days = '') {
                const row = document.createElement('div');
                row.classList.add('flex', 'flex-col', 'sm:flex-row', 'gap-3', 'items-end', 'bg-gray-50', 'p-4', 'rounded-xl', 'border', 'border-gray-200');
                row.innerHTML = `
                    <div class="flex-1">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Nombre Completo:</label>
                        <input type="text" value="${name}" class="w-full p-3 border-2 border-gray-200 rounded-xl name-input input-field focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none" placeholder="Antonio L√≥pez">
                    </div>
                    <div class="flex-1">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">D√≠as que no puede (ej: 6, 13):</label>
                        <input type="text" value="${days}" class="w-full p-3 border-2 border-gray-200 rounded-xl days-input input-field focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none" placeholder="3, 10, 17">
                    </div>
                    <button class="p-3 text-red-500 hover:bg-red-50 rounded-xl transition-all duration-200 remove-btn" aria-label="Eliminar restricci√≥n">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </button>
                `;
                restrictionsContainer.appendChild(row);
                row.querySelector('.remove-btn').addEventListener('click', () => {
                    restrictionsContainer.removeChild(row);
                });
            }

            function getRestrictionsFromInputs() {
                const restrictions = {};
                const restrictionRows = restrictionsContainer.querySelectorAll('.flex.flex-col.sm\\:flex-row.gap-3');
                restrictionRows.forEach(row => {
                    const nameInput = row.querySelector('.name-input');
                    const daysInput = row.querySelector('.days-input');
                    if (nameInput && daysInput) {
                        const name = nameInput.value.trim();
                        const daysStr = daysInput.value;
                        if (name && daysStr) {
                            const days = daysStr.split(',').map(d => parseInt(d.trim())).filter(d => !isNaN(d));
                            restrictions[name] = days;
                        }
                    }
                });
                return restrictions;
            }

            generateBtn.addEventListener('click', () => {
                scheduleContainer.innerHTML = '';
                
                const teams = getTeamsFromInputs();
                if (teams.length === 0) {
                    showAlert('Error', 'Debes agregar al menos un equipo con miembros.');
                    return;
                }

                const allTeamMembers = teams.flatMap(team => team.members);
                const uniqueMembers = [...new Set(allTeamMembers)];
                const restrictions = getRestrictionsFromInputs();
                const rotationMembers = rotationListEl.value.split('\n').map(name => name.trim()).filter(name => name);
                const specificDays = getDaysFromInputs();
                
                if (specificDays.length === 0) {
                    showAlert('Error', 'Debes agregar al menos un d√≠a al horario.');
                    return;
                }

                const selectedMonth = monthSelect.value;
                const selectedYear = yearInput.value;
                const scheduleTitle = scheduleTitleEl.value || `Horario de ${selectedMonth} ${selectedYear}`;
                
                const fullSchedule = generateCombinedSchedule(specificDays, teams, uniqueMembers, restrictions, rotationMembers, selectedMonth, selectedYear);
                renderSingleSchedule(fullSchedule, teams, scheduleTitle);
                
                showAlert('¬°√âxito!', 'Horario generado correctamente. Puedes exportarlo a PDF o Excel.');
            });

            exportPdfBtn.addEventListener('click', () => {
                const scheduleElement = scheduleContainer.querySelector('div');
                if (!scheduleElement) {
                    showAlert('Error', 'Primero, genera un horario para poder exportarlo.');
                    return;
                }
                
                const buttonsDiv = document.querySelector('.flex.flex-wrap.gap-3');
                const originalDisplay = buttonsDiv.style.display;
                buttonsDiv.style.display = 'none';

                html2canvas(scheduleElement, {
                    scale: 2,
                    useCORS: true,
                    backgroundColor: '#ffffff',
                }).then(canvas => {
                    buttonsDiv.style.display = originalDisplay;
                    
                    const { jsPDF } = window.jspdf;
                    const imgData = canvas.toDataURL('image/png');
                    const doc = new jsPDF('p', 'mm', 'a4');
                    
                    const imgWidth = 210;
                    const pageHeight = 297;
                    const imgHeight = canvas.height * imgWidth / canvas.width;
                    let heightLeft = imgHeight;
                    let position = 0;
                    
                    doc.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                    
                    while (heightLeft >= 0) {
                        position = heightLeft - imgHeight;
                        doc.addPage();
                        doc.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                        heightLeft -= pageHeight;
                    }

                    doc.save('horario-generado.pdf');
                    showAlert('¬°√âxito!', 'Horario exportado a PDF correctamente.');
                }).catch(error => {
                    console.error("Error al generar PDF:", error);
                    buttonsDiv.style.display = originalDisplay;
                    showAlert('Error', 'Ocurri√≥ un error al generar el PDF.');
                });
            });

            exportExcelBtn.addEventListener('click', () => {
                const scheduleTable = scheduleContainer.querySelector('table');
                if (scheduleTable) {
                    const ws = XLSX.utils.table_to_sheet(scheduleTable, { cellDates: false, raw: true });
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "Horario");
                    const title = scheduleTitleEl.value.trim() || 'horario_generado';
                    XLSX.writeFile(wb, `${title}.xlsx`);
                    showAlert('¬°√âxito!', 'Horario exportado a Excel correctamente.');
                } else {
                    showAlert('Error', 'Primero, genera un horario para poder exportar a Excel.');
                }
            });

            function generateCombinedSchedule(days, teams, allMembers, restrictions, rotationMembers, month, year) {
                const fullSchedule = {};
                const assignmentCounts = {};
                allMembers.forEach(member => {
                    assignmentCounts[member] = 0;
                });
    
                days.forEach(dayInfo => {
                    const availableMembers = allMembers.filter(member => {
                        return !(restrictions[member] && restrictions[member].includes(dayInfo.date));
                    });
                    
                    const dayAssignments = {};
                    const assignedForToday = [];
    
                    const shuffledTeams = [...teams];
                    randomShuffle(shuffledTeams);
    
                    shuffledTeams.forEach(team => {
                        dayAssignments[team.name] = 'Sin asignar';
    
                        const teamCandidates = team.members.filter(member =>
                            availableMembers.includes(member) &&
                            !assignedForToday.includes(member)
                        );
    
                        const candidates = teamCandidates.sort((a, b) => {
                            const isArotation = rotationMembers.includes(a);
                            const isBrotation = rotationMembers.includes(b);
    
                            if (isArotation === isBrotation) {
                                return assignmentCounts[a] - assignmentCounts[b];
                            }
                            
                            return isArotation ? 1 : -1;
                        });
    
                        if (candidates.length > 0) {
                            const selectedMember = candidates[0];
                            dayAssignments[team.name] = selectedMember;
                            assignedForToday.push(selectedMember);
                            assignmentCounts[selectedMember]++;
                        }
                    });
    
                    fullSchedule[`${dayInfo.day} ${dayInfo.date} ${month} ${year}`] = dayAssignments;
                });
    
                return fullSchedule;
            }
            
            function renderSingleSchedule(schedule, teams, scheduleTitle) {
                if (Object.keys(schedule).length === 0) return;
                
                const teamNames = teams.map(t => t.name);

                let html = `
                    <div class="bg-white p-6 rounded-2xl border-2 border-green-200 shadow-lg">
                        <h2 class="text-3xl font-bold text-gray-800 text-center mb-6 pb-4 border-b-2 border-gray-200">${scheduleTitle}</h2>
                        <div class="overflow-x-auto">
                            <table class="min-w-full text-left border-collapse">
                                <thead>
                                    <tr class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white">
                                        <th class="p-4 text-sm font-bold tracking-wide">FECHAS</th>
                                        ${teamNames.map(name => `<th class="p-4 text-sm font-bold tracking-wide">${name.toUpperCase()}</th>`).join('')}
                                    </tr>
                                </thead>
                                <tbody>
                                    ${Object.keys(schedule).map((day, index) => `
                                        <tr class="${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'} hover:bg-indigo-50 transition-colors duration-200">
                                            <td class="p-4 text-sm font-bold text-gray-800 border-b border-gray-200">${day}</td>
                                            ${teamNames.map(name => `<td class="p-4 text-sm text-gray-700 border-b border-gray-200">${schedule[day][name]}</td>`).join('')}
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                        <div class="mt-6 p-4 bg-blue-50 rounded-xl border border-blue-200">
                            <p class="text-sm text-gray-600 text-center">
                                ‚ú® Horario generado con distribuci√≥n equitativa de cargas
                            </p>
                        </div>
                    </div>
                `;
                scheduleContainer.innerHTML = html;
            }
            
            function randomShuffle(array) {
                let currentIndex = array.length, randomIndex;
                while (currentIndex !== 0) {
                    randomIndex = Math.floor(Math.random() * currentIndex);
                    currentIndex--;
                    [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
                }
                return array;
            }

            function downloadBackup() {
                const teams = getTeamsFromInputs();
                const restrictions = getRestrictionsFromInputs();
                const rotationList = rotationListEl.value;
                const days = getDaysFromInputs();
                const month = monthSelect.value;
                const year = yearInput.value;
                const backupData = {
                    teams,
                    restrictions,
                    rotationList,
                    days,
                    month,
                    year
                };
                
                const dataStr = JSON.stringify(backupData, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `horario-backup-${month}-${year}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                showAlert('Copia de Seguridad', `Datos guardados exitosamente. Se ha descargado el archivo "horario-backup-${month}-${year}.json".`);
            }

            function loadBackupFromFile(file) {
                if (!file) {
                    showAlert('Error', 'No se seleccion√≥ ning√∫n archivo.');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const backupData = JSON.parse(event.target.result);
                        if (backupData && backupData.teams && backupData.restrictions) {
                            teamsContainer.innerHTML = '';
                            backupData.teams.forEach(team => addTeamRow(team.name, team.members.join('\n')));

                            restrictionsContainer.innerHTML = '';
                            restrictionsContainer.innerHTML = '<p class="text-sm text-gray-600 bg-blue-50 p-3 rounded-lg border border-blue-200">üìÖ Agrega los d√≠as en que cada persona no est√° disponible</p>';
                            Object.keys(backupData.restrictions).forEach(member => {
                                addRestrictionRow(member, backupData.restrictions[member].join(', '));
                            });

                            rotationListEl.value = backupData.rotationList || '';
                            
                            daysContainer.innerHTML = '';
                            if (backupData.days && backupData.days.length > 0) {
                                backupData.days.forEach(day => addDayRow(day.day, day.date));
                            } else {
                                addDayRow();
                            }

                            if (backupData.month) {
                                monthSelect.value = backupData.month;
                            }
                            if (backupData.year) {
                                yearInput.value = backupData.year;
                            }

                            showAlert('Copia de Seguridad', 'Datos cargados exitosamente desde el archivo.');
                        } else {
                            showAlert('Error', 'El archivo no tiene un formato de respaldo v√°lido.');
                        }
                    } catch (e) {
                        console.error('Error al procesar el archivo:', e);
                        showAlert('Error', 'Hubo un problema al leer el archivo. Aseg√∫rate de que es un archivo de respaldo v√°lido.');
                    }
                };
                reader.onerror = () => {
                    showAlert('Error', 'No se pudo leer el archivo.');
                };
                reader.readAsText(file);
            }

            saveBackupBtn.addEventListener('click', downloadBackup);
            
            loadBackupBtn.addEventListener('click', () => {
                backupFileInput.click();
            });

            backupFileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                loadBackupFromFile(file);
            });

            if (daysContainer.children.length === 0) {
                addDayRow();
            }
        });
    </script>
</body>
</html>
